# AI审校助手项目结构说明

## 目录结构

1. **config/** - 配置管理目录
   - `__init__.py` (57行)
     - 配置系统的核心初始化模块
     - 管理全局配置变量的加载和访问（API密钥、模块类型、审校表格设置等）
     - 提供配置文件路径管理函数
     - 处理配置加载异常情况
     - 通过`__all__`导出关键配置变量和管理器
     - 简化了路径处理逻辑，直接使用path_manager
     - 添加医学RAG系统配置
   - `constants.py` (72行)
     - 定义系统全局常量，采用模块化结构
     - 包含AI模型列表配置（gpt-4o, gpt-4o-mini, 通义千问）
     - 定义UI标签名称映射和界面布局参数
     - 设置默认提示语和系统版本信息
     - 通过`__all__`明确导出所有常量
     - 添加医学RAG系统相关常量
     - 新增结构化提示词模板，支持AI审校结构化输出
   - `core/` - 配置核心模块目录
     - `__init__.py` (8行)
       - 导出配置管理器和路径管理器
       - 作为配置功能的核心入口点
       - 简化了模块导入路径
   - `managers/` - 配置管理器目录
     - `__init__.py` (8行)
       - 导出path_manager和config_manager实例
       - 便于其他模块统一导入管理器
     - `config_manager.py` (180行)
       - 配置管理器的核心实现
       - 处理配置的加载和保存
       - 验证API密钥格式
       - 管理配置界面组件
       - 提供默认配置创建功能
       - 集成主题管理
       - 集成医学RAG系统配置界面
     - `path_manager.py` (87行)
       - 系统路径管理器
       - 管理项目所有重要路径
       - 处理开发环境和打包环境的路径差异
       - 提供文件路径生成功能
       - 确保必要目录结构的存在
   - `settings/` - 详细配置目录
     - `__init__.py` (34行)
       - 加载和导出主题配置
       - 加载和导出应用配置
       - 提供配置加载工具函数（load_theme和load_app_config）
       - 处理配置加载异常
       - 通过`__all__`导出配置对象和函数
     - `theme.json` (30行)
       - 定义系统主题配置
       - 包含颜色方案定义
       - 设置字体样式和大小
       - 定义界面间距和边框
       - 配置动画持续时间

2. **build/** - 构建工具目录
   - `installer.py` (1045行)
     - 安装程序的主要实现
     - 包含图形界面安装向导
     - 处理文件复制、快捷方式创建等安装任务
     - 集成主题管理和日志记录功能
   - `build_all.py` (450行)
     - 项目构建脚本
     - 管理构建过程的日志记录
     - 处理主程序、安装程序和密钥生成器的打包
     - 实现构建目录的清理和管理
     - 自动将spec文件移动到specs目录
   - `file_version_info.txt` (29行)
     - 文件版本信息配置
     - 定义应用程序版本号和描述信息
   - `specs/` - PyInstaller配置文件目录
     - `ai_review.spec` (84行) - 主程序打包配置
       - 使用绝对路径引用资源文件
       - 配置窗口化应用设置
       - 主程序依赖项管理
     - `installer.spec` (97行) - 安装程序打包配置
       - 使用绝对路径处理资源文件
       - 配置调试和UI设置
     - `key_generator.spec` (55行) - 密钥生成器打包配置
       - 定义密钥生成器依赖项
       - 配置窗口化应用设置
   - `build_logs/` - 构建日志目录
     - 存储构建过程的详细日志
     - 按时间戳命名的日志文件
   - `dist/` - 构建输出目录
     - 存放生成的可执行文件
     - 包含主程序、安装程序和密钥生成器

3. **src/** - 源代码目录
   - `core/` - 核心功能实现
     - `text_processor.py` (539行)
       - 文本处理核心模块
       - 实现文本分析、分段和格式化
       - 支持多种文本处理算法
     - `ai_review.py` (277行)
       - AI审校功能的主要实现
       - 集成多个AI模型接口
       - 处理审校结果的格式化
       - 集成医学RAG系统进行医学事实性判断
       - 新增结构化输出处理功能
       - 提供格式化审校结果转换功能
       - 支持命令行彩色输出
       - 根据运行方式自适应输出形式（命令行/弹窗）
       - 优化了文件处理流程和进度显示
       - 移除了文本差异比较功能，使用AI直接返回修改建议
       - 改进了命令行输出格式，移除特殊标记
       - 分离了命令行显示和文件写入的格式处理
     - `r2_framework/` - R² 框架核心实现（新增）
       - `__init__.py` (180行)
         - 导出框架核心功能
         - 定义 R2Framework 主类
         - 整合 Reader、Rewriter、Refiner 三个组件
         - 提供完整的处理流程接口
         - 支持批量处理和结果导出
       - `reader.py` (180行)
         - Reader模块实现
         - 事件和角色信息提取
         - 集成HAR算法进行幻觉修复
       - `rewriter.py` (150行)
         - Rewriter模块实现
         - 基于因果图生成剧本
         - 使用HAR优化生成内容
       - `refiner.py` (219行)
         - Refiner模块实现
         - 提供场景分析和优化建议
         - 支持多维度优化（情节、人物、风格、逻辑）
         - 使用HAR进行事实验证
         - 实现场景内容的迭代优化
       - `event_processor.py` (120行)
         - 事件处理与因果图构建
         - 实现事件提取和关系分析
         - 整合CPC算法构建无环图
   
   - `ui/` - 用户界面组件
     - `config_editor.py` (118行)
       - 配置编辑器界面
       - 提供配置项可视化编辑
     - `app.py` (51行)
       - 应用程序主窗口
       - 管理界面组件的加载和布局
     - `pages/` - 页面组件目录
       - `__init__.py` (6行)
         - 定义页面模块的导出内容
         - 避免循环导入问题
       - `key_verify_page.py` (57行)
         - 密钥验证页面实现
         - 包含密钥输入和验证功能
         - 验证成功后跳转到主页
         - 集成主题管理
       - `process_page.py` (224行)
         - 文件处理页面实现
         - 支持自动处理和人工审校两种模式
         - 包含进度显示窗口
         - 使用多线程处理文件
         - 实时显示处理进度
       - `start_page.py` (277行)
         - 应用程序主页面
         - 提供文件上传、清理功能
         - 包含配置管理界面
         - 支持配置的保存和加载
         - 实现主题切换功能
     - `components/` - UI组件目录
     - `styles/` - 界面样式目录
   
   - `utils/` - 工具函数集合
     - `ai_utils.py` (141行)
       - AI相关工具函数
       - 处理API调用和响应
       - 添加Function Calling支持
       - 实现文本审校工具函数Schema
       - 定义结构化JSON输出格式
       - 优化错误处理和响应解析
       - 支持多种模型的结构化输出处理
     - `text_utils.py` (180行)
       - 文本处理工具函数
       - 提供文本分析和转换功能
       - 实现文本差异对比高亮显示
       - 支持8种协调的颜色方案（金黄、天蓝、翠绿、淡紫、橙色、青蓝、淡黄、紫罗兰）
       - 提供智能文本分割和合并功能
       - 支持多种文本格式化处理
       - 实现差异对比的可视化展示
     - `table_utils.py` (130行)
       - 表格处理工具
       - 支持多种表格格式转换
     - `docx_utils.py` (119行)
       - Word文档处理工具
       - 实现文档读写和格式化
     - `file_utils.py` (66行)
       - 文件操作工具
       - 处理文件读写和路径管理
     - `cleanup_utils.py` (54行)
       - 清理工具函数
       - 处理临时文件和缓存管理
     - `rag_utils.py` (210行)
       - 医学RAG系统工具函数
       - 实现基于LangChain的文档检索和问答系统
       - 支持医学文档的向量化和检索
       - 提供医学事实性判断功能
     - `semantic_divider.py` (141行)
       - 语义分割模块
       - 实现基于语义的智能文本分割功能
       - 支持自然段落的识别和分割
       - 智能识别并合并引用类文本
       - 自动关联标题与其对应内容
       - 使用 AI 分析段落间的语义关联度
       - 根据语义相关性和长度限制合并段落
     - `graph_utils.py` (95行)
       - 因果图处理工具
       - 提供图结构操作接口
       - 支持图的可视化展示
     - `har_utils.py` (120行)
       - HAR算法实现
       - 幻觉检测与修复
       - 支持多轮优化迭代
     - `cpc_utils.py` (85行)
       - CPC算法实现
       - 因果图断环处理
       - 边权重管理

   - `security/` - 安全相关功能
     - `key_generator.py` (89行)
       - 密钥生成器
       - 实现安全密钥的生成和管理
     - `time_lock.py` (25行)
       - 时间锁定功能
       - 控制程序的使用时间限制
     - `key_generator_legacy.py` (19行)
       - 旧版密钥生成器
       - 保持向后兼容性
     - `key_verifier.py` (38行)
       - 密钥验证器
       - 验证密钥的有效性
       
   - `config/` - 源代码级配置目录
     - `__init__.py` (12行)
       - 导出配置相关功能
       - 简化模块导入路径
     - `client_config.py` (45行)
       - 客户端配置管理
       - 处理本地配置参数
       - 实现配置文件的同步机制
     - `model_config.py` (68行)
       - AI模型配置管理
       - 定义不同模型的参数设置
       - 处理模型切换和配置更新

4. **tests/** - 测试目录
   - `test_ai_review.py` (45行)
     - AI审校功能的单元测试
     - 包含文本审校和批量审校的测试用例
     - 使用unittest框架实现测试
   - `test_medical_rag.py` (120行)
     - 医学RAG系统的独立测试模块
     - 实现不依赖UI界面的RAG功能测试
     - 支持通过命令行参数控制测试行为
     - 包含文档加载、系统初始化、搜索和上下文获取的测试

5. **hide_file/** - 隐藏文件目录
   - `config_files/` - 配置文件目录
     - `config.json` - 应用程序配置文件
     - `config_demo.json` - 配置文件模板示例
   - `temp_files/` - 中间文件目录
     - `original_files/` - 原始文件目录
       - 存放需要审校的原始文件
       - 支持导入Word文档（.docx）
     - `reviewed_files/` - 审校后文件目录
       - 存放审校完成的文件
       - 包含最终生成的Word文档（.docx）
     - 存放处理过程中的临时文件（中间结果）
   - `medical_reference/` - 医学参考文档目录
     - `documents/` - 医学文档上传目录
       - 存放用户上传的医学参考文档（PDF、TXT、CSV等）
       - 仅含用户可读文档，由上传功能添加
       - `README.txt` - 说明文件
     - `chroma_db/` - 向量数据库存储目录
       - 存储文档的向量化表示
       - 由系统自动创建和管理
       - 用于快速检索相关医学信息
     - `README.txt` - 主说明文件 

## 语义分割器改进

`src/utils/semantic_divider.py` 文件（141行）实现了智能语义分割功能：

1. 自然段落分割
   - 使用空行作为分隔符
   - 保持原始格式和缩进
   - 支持多行段落的正确处理

2. 语义特征识别
   - 标题和子标题识别
   - 图片和作者信息识别
   - 引用和注释识别
   - 短段落识别

3. 智能合并策略
   - 基于章节关系智能合并
   - 保持引用和注释的独立性
   - 考虑段落长度限制
   - 使用AI分析段落间的语义关联度
   - 根据语义相关性动态调整合并策略 

3. **models/** - 模型定义（新增）
   - `__init__.py` (15行)
     - 导出所有模型类
   - `event.py` (45行)
     - 事件模型定义
     - 事件属性和关系描述
   - `character.py` (40行)
     - 角色模型定义
     - 角色信息和关系描述
   - `causal_graph.py` (75行)
     - 因果图模型定义
     - 图结构和操作接口
     - 支持序列化和持久化 