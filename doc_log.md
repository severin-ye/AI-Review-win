# 项目更改日志

## 日志书写规范

1. 日期格式
   - 新的一天使用二级标题（##），格式：`## YYYY-M-D`
   - 同一天的多个更新使用三级标题（###），格式：`### 更新 N`
   - 序号从1开始，按时间顺序递增
   - **重要：新的日期由用户手动添加，AI助手不应自行添加日期**

2. 条目格式
   - 新的一天使用二级标题（##）
   - 同一天的更新使用三级标题（###）
   - 主要更改使用一级列表（-）
   - 详细说明使用二级列表（2个空格后的-）
   - 保持缩进的一致性

3. 内容要求
   - 每个更新必须说明具体改动内容
   - 涉及文件改动时使用代码引用格式（`文件名`）
   - 包含对文档的更新说明
   - 保持更新内容的完整性和连贯性

4. 文档同步
   - 所有更改都要同步更新相关文档
   - 确保文档结构与实际代码保持一致
   - 重要更改需要更新技术文档

5. 日志添加位置
   - **新的日志条目必须添加在最新日期的底部**
   - **禁止在历史日志中间插入或修改已有日志**
   - 每个新的更新使用递增的序号

---

## 2025-3-31
### 更新 1
- 重构AI审校逻辑，实现结构化输出功能
  - 修改`src/utils/ai_utils.py`，添加Function Calling支持
  - 更新`src/core/ai_review.py`，实现结构化输出处理
  - 优化AI审校结果显示格式，提供更清晰的修改建议
  - 引入文本审校工具函数Schema，统一审校输出格式
  - 支持修改建议的结构化呈现（原文+修改后文本）
- 优化提示词配置
  - 更新`config/constants.py`中的默认提示词
  - 添加专门针对文本审校和医学审校的结构化提示词
  - 规范化提示词格式，要求AI返回JSON结构
- 增强兼容性
  - 同时支持OpenAI和通义千问模型的结构化输出
  - 对通义千问模型添加特殊处理，确保输出格式一致
  - 保留对非结构化输出的向后兼容性支持
- 提升用户体验
  - 优化审校结果展示，使修改建议更加清晰
  - 改进差异对比展示，直接使用结构化修改建议
  - 当无需修改时显示明确提示，避免困惑

### 更新 4
- 优化命令行输出格式
  - 在`ai_review.py`中添加彩色输出支持
  - 使用不同颜色区分不同类型的信息（蓝色用于文件信息，绿色用于进度和成功信息，黄色用于段落信息和警告）
  - 添加清晰的分隔线和段落编号
  - 优化进度显示格式
- 改进运行方式适配
  - 添加运行方式判断逻辑
  - 直接运行时使用命令行输出
  - 被其他模块调用时保持弹窗提示
  - 确保用户体验的一致性
- 简化代码结构
  - 移除文本差异比较相关代码
  - 删除`similarity_utils.py`模块
  - 直接使用AI返回的结构化修改建议
  - 优化文件处理流程
- 更新项目文档
  - 更新`doc_Structure_Description.md`，反映最新的代码结构
  - 更新行数统计和功能描述
  - 添加新功能的说明

## 2025-3-28
### 更新 1
- 将 README.md 从中文翻译成英文
- 将 doc_Structure_Description.md 从中文翻译成英文
- 更新项目文档以保持所有文件的一致性
- 将 `安装程序.spec` 重命名为 `installer_cn.spec` 以更好地支持国际化

### 更新 2
- 将 doc_Structure_Description.md 的详细内容整合到 docs/ARCHITECTURE.md 中
- 更新了架构文档，添加了详细的目录结构说明
- 保持了文档的一致性和完整性

### 更新 3
- 重构了构建系统的目录结构
  - 将 `build_logs` 目录移入 `build` 目录
  - 将 `dist` 目录移入 `build` 目录
  - 创建 `specs` 目录统一管理所有 `.spec` 文件
  - 将 `ai_review.spec` 和 `installer.spec` 移入 `build/specs` 目录
- 更新了 `build_all.py` 和 `installer.spec` 以适应新的目录结构
- 使用绝对路径处理资源文件，提高了构建过程的可靠性
- 更新了项目结构文档以反映这些更改

### 更新 4
- 进一步完善构建系统
  - 修复了密钥生成器的构建问题，创建了稳定的 `key_generator.spec` 文件
  - 修改所有组件配置，使其在运行时不显示终端窗口
  - 添加了更健壮的错误处理和日志记录
  - 实现了自动清理工作目录的机制，避免冗余文件
  - 确保所有 spec 文件使用绝对路径引用资源
- 完善了构建脚本的自动化程度，减少手动干预步骤
- 同步更新项目结构文档和更改日志，保持文档的一致性

### 更新 5
- 删除了不再使用的 `src/scripts` 目录
  - 所有构建相关功能已经移动到项目根目录下的 `build` 目录
  - 清理了项目结构，移除冗余内容
- 更新了项目文档，反映目录结构的变化

### 更新 6
- 重构了 `config` 目录结构，提高了模块化和可维护性
  - 创建了 `core` 子目录集中管理配置核心功能
  - 移除了空的 `theme_config` 和 `app_config` 目录
  - 优化了 `settings` 模块，增加了应用配置加载功能
  - 改进了 `constants.py` 文件结构，添加了版本信息
  - 简化了 `config/__init__.py` 中的路径处理逻辑，减少冗余代码
- 更新了项目结构文档，反映配置目录的变化
- 保持了文档和工作区结构的一致性

### 更新 7
- 完善了 `config` 目录的文档说明
  - 更新了 `doc_Structure_Description.md` 中的详细结构描述
  - 为所有配置相关文件添加了准确的行数信息
  - 增加了对配置模块功能和关系的详细说明
  - 明确了各个子模块的职责和功能边界
  - 突出了配置系统的模块化设计和良好结构
- 验证了配置模块的正常运行

### 更新 8
- 重构了 `src` 目录结构
  - 优化了核心模块组织，提高代码可读性和维护性
  - 确保所有模块之间的接口清晰和一致
  - 改进了模块间的依赖关系，减少了循环导入问题
  - 统一了代码风格和命名约定
- 更新了所有相关文档，确保与代码结构一致
- 项目结构文档保持同步更新

### 更新 9
- 创建了 `docs` 目录用于集中管理项目文档
  - 将技术架构文档移入 `docs/ARCHITECTURE.md`
  - 添加了详细的API文档
  - 创建了用户手册和开发指南
- 确保所有现有文档的一致性和完整性
- 更新了项目结构文档以反映这些变化

## 2025-3-30
### 更新 1
- 添加基于LangChain的医学RAG系统
- 实现医学文档的向量化和检索功能
- 集成医学事实性判断到AI审校流程
- 优化配置界面，添加医学RAG相关配置
- 创建医学参考文档目录和管理功能
- 添加适配医学RAG的提示语模板

### 更新 2
- 修复了config模块中的循环导入问题
  - 修改了config/core/__init__.py，移除循环导入
  - 调整了config_manager.py中的导入方式，使用相对导入
  - 在PathManager类中添加了缺失的方法（get_app_config_path, get_theme_config, get_default_output_dir）
  - 添加了ThemeManager类，提供字体管理功能
- 优化了配置编辑器的错误处理
  - 添加了详细的错误跟踪和日志记录
  - 改进项目路径处理，确保正确加载模块
- 系统稳定性得到提升，避免启动时的循环导入错误

### 更新 3
- 修改文件清理逻辑，避免自动清空文件
  - 重构了`src/utils/cleanup_utils.py`模块
  - 将自动执行的清理代码移到`cleanup_all_directories`函数中
  - 修改了清理代码，使其只在明确调用时才执行，而不是在导入时自动执行
  - 更新了`main.py`，明确在启动时调用清理函数
- 解决了直接运行`ai_review.py`时自动清空文件的问题
  - 确保只有在运行`main.py`主程序时才清空文件
  - 在直接运行其他模块时保留原始文件
  - 改进了用户体验，避免意外丢失处理文件

### 更新 4
- 更新医学RAG系统以适配LangChain最新版本
  - 修复了由于LangChain库重组导致的导入错误
  - 添加了langchain-community依赖项
  - 更新了向量存储、嵌入模型和文档加载器的导入路径
  - 将Document导入从langchain.schema更新为langchain_core.documents
- 更新了setup.py，明确添加了langchain-community依赖
- 修复了项目启动时的模块导入错误问题

### 更新 5
- 进一步优化医学RAG系统
  - 添加了langchain-huggingface依赖和导入
  - 更新了HuggingFaceEmbeddings的导入路径
  - 解决了启动时的弃用警告问题
  - 添加了警告过滤机制，优化用户体验
- 更新了项目依赖管理
  - 在setup.py中添加了所有最新必要依赖
  - 确保依赖说明准确反映了项目需求
- 进行了彻底的兼容性测试
  - 验证在Windows环境下的运行稳定性
  - 确保所有功能模块正常工作

### 更新 6
- 修复UI界面相关问题
  - 解决了ConfigEditor返回主页后出现空白页面的bug
  - 优化了StartPage中的show_main_page方法，避免不必要的重新初始化
  - 重构了ConfigEditor，使用ConfigManager的create_config_ui方法
  - 提高了UI界面在各种情况下的稳定性和一致性

### 更新 7
- 优化了项目目录结构
  - 将`_1_原文件`目录移动到`hide_file\中间文件\_1_原文件`
  - 将`_2_审校后`目录移动到`hide_file\中间文件\_2_审校后`
  - 将`_4_医学参考文档`目录移动到`hide_file\配置文件\_4_医学参考文档`
- 优化了PathManager类
  - 改进了PathManager的目录结构定义和管理
  - 添加医学参考文档目录管理功能
  - 确保所有必要目录自动创建
- 更新了文件处理工具类
  - 更新了file_utils.py，使用PathManager生成路径
  - 更新了table_utils.py，适配新的目录结构
  - 更新了rag_utils.py，使用PathManager获取医学参考文档目录
  - 修复了cleanup_utils.py，更新清理目录逻辑
- 更新了启动和UI模块
  - 修复了StartPage中的上传文件和清理文件功能
  - 更新了配置初始化逻辑，避免手动创建目录
  - 确保应用在新目录结构下正常运行
- 文档更新
  - 更新了项目结构描述文档，反映目录变化
  - 添加了更改日志条目

### 更新 8
- 将目录结构改为英文名称
  - 将`中间文件`目录改名为`temp_files`
  - 将`配置文件`目录改名为`config_files`
  - 将`医学参考文档`目录改名为`medical_reference`
  - 将`_1_原文件`目录改名为`original_files`
  - 将`_2_审校后`目录改名为`reviewed_files`
- 更新了PathManager类以使用新的英文目录名
  - 修改了所有相关路径定义
  - 确保目录结构一致性
  - 保持代码和实际目录结构的同步
- 更新了项目文档
  - 更新了项目结构描述文档，使用英文目录名
  - 添加了更改日志条目
- 提升了国际化兼容性

### 更新 9
- 更新`.gitignore`文件以匹配当前项目目录结构
  - 将`hide_file/配置文件/`路径修改为`hide_file/config_files/`
  - 确保敏感配置文件被正确排除在版本控制外
  - 保持与当前英文目录命名一致
- 更新项目结构文档和代码一致性
  - 确保文档中的目录路径与实际代码一致
  - 更新`doc_Structure_Description.md`中的目录描述

### 更新 10
- 添加了上传医学参考文档功能
  - 在StartPage主页面添加了"上传医学参考"按钮
  - 实现了上传医学参考文档到medical_reference目录的功能
  - 支持上传PDF、TXT、CSV和Word等多种格式的医学文档
  - 添加用户友好的操作提示和结果反馈
- 优化了医学参考文档管理流程
  - 使用path_manager确保医学参考文档目录的自动创建
  - 保证上传过程的目录结构一致性
  - 提示用户文档将在下次启动时自动索引

### 更新 11
- 添加了医学RAG系统的独立测试脚本
  - 创建了`tests/test_medical_rag.py`测试模块
  - 实现了不依赖UI界面的RAG功能测试
  - 支持通过命令行参数控制测试行为
  - 包含文档加载、系统初始化、搜索和上下文获取的测试
- 增强了医学RAG系统的可测试性
  - 设计了模块化的测试类结构
  - 添加了详细的日志记录功能
  - 提供了性能指标监测（如加载时间、搜索时间）
  - 支持针对特定测试用例的个性化配置

### 更新 12
- 优化了医学参考文档目录结构
  - 在`medical_reference`目录下创建了`documents`子目录专门用于存放上传的医学文档
  - 分离了用户上传文档区域和系统向量数据库区域
  - 添加了清晰的子目录README说明文件
  - 改进了目录结构的可维护性
- 更新了医学RAG系统实现
  - 在PathManager中添加了医学文档上传目录和数据库目录的专用方法
  - 更新了RAG工具类，使用新的目录结构
  - 确保新的目录结构自动创建
  - 优化了向量数据库的存储位置管理
- 修改了上传医学参考文档功能
  - 更新了文件上传目标路径为documents子目录
  - 改进了用户反馈信息
  - 确保上传操作与新目录结构兼容

### 更新 13
- 更新了README.md文件
  - 添加了关于医学RAG系统的详细描述
  - 更新了项目目录结构说明，使其与当前结构一致
  - 细化了每个主要目录的功能描述
  - 在功能列表中添加了医学RAG系统功能
  - 更新了使用指南，添加了医学参考文档上传步骤
  - 更新了配置指南，添加了支持的具体AI模型（GPT-4o、GPT-4o-mini、通义千问）
  - 添加了专门的医学RAG系统说明部分
  - 完善了开发指南

## 2025-3-31
### 更新 1
- 修复了OpenAI API密钥验证规则
  - 更新了`config_manager.py`中的密钥格式验证函数
  - 修改正则表达式以接受以`sk-proj-`开头的密钥格式
  - 允许密钥中包含破折号`-`和下划线`_`字符
  - 移除了固定长度(48字符)的限制，改为验证前缀
- 统一了配置文件结构
  - 修正了`config.json`文件结构，使用扁平结构而非嵌套结构
  - 更新了`config_demo.json`示例文件，与实际配置结构保持一致
  - 确保配置文件中字段格式与程序预期一致
- 改进了配置保存和加载机制
  - 确保UI界面上的配置能正确保存到文件
  - 修复了API密钥格式验证导致的保存失败问题

### 更新 2
- 修复文件处理路径问题
  - 修改了`src/ui/pages/process_page.py`中的`auto_process`方法
  - 更新了`src/core/ai_review.py`中的主程序入口部分
  - 将硬编码的`_1_原文件`路径替换为`path_manager.original_files_dir`
  - 确保系统从正确的`hide_file/temp_files/original_files`目录获取文件
- 解决了文件处理时"没有找到需要处理的文件"警告的问题
  - 确保处理功能正确识别`original_files`目录中的文件
  - 修复了目录结构更新后的路径适配问题

### 更新 3
- 修改文件清理逻辑，避免自动清空文件
  - 重构了`src/utils/cleanup_utils.py`模块
  - 将自动执行的清理代码移到`cleanup_all_directories`函数中
  - 修改了清理代码，使其只在明确调用时才执行，而不是在导入时自动执行
  - 更新了`main.py`，明确在启动时调用清理函数
- 解决了直接运行`ai_review.py`时自动清空文件的问题
  - 确保只有在运行`main.py`主程序时才清空文件
  - 在直接运行其他模块时保留原始文件
  - 改进了用户体验，避免意外丢失处理文件

### 更新 4
- 改进了语义分割器（semantic_divider.py）的智能分析功能：
  1. 优化了自然段落分割逻辑
     - 使用空行作为主要分隔符
     - 保持原始格式和缩进
     - 支持多行段落的正确处理
  2. 增强了语义特征识别能力
     - 添加了更多文本块类型识别
     - 改进了标题和子标题的识别
     - 优化了作者信息和引用的处理
  3. 改进了段落合并策略
     - 基于章节关系智能合并
     - 保持引用和注释的独立性
     - 考虑段落长度限制
  4. 测试用例更新
     - 添加了详细的测试输出
     - 显示段落字数统计
     - 展示语义分析结果

## 2024-03-31

改进了语义分割器的功能：

1. 优化了自然段落分割逻辑
   - 使用空行作为主要分隔符
   - 保持原始格式和缩进
   - 支持多行段落的正确处理

2. 增强了语义特征识别能力
   - 添加了更多文本块类型识别
   - 改进了标题和子标题的识别
   - 优化了作者信息和引用的处理

3. 改进了段落合并策略
   - 基于章节关系智能合并
   - 保持引用和注释的独立性
   - 考虑段落长度限制

4. 测试用例更新
   - 添加了详细的测试输出
   - 显示段落字数统计
   - 展示语义分析结果

### 更新 5
- 优化命令行输出格式
  - 修改`src/core/ai_review.py`中的输出处理逻辑
  - 移除命令行输出中的`[first_line_indent]`标记
  - 在写入文件时保留`[first_line_indent]`标记以便后续处理
  - 确保输出格式的一致性和可读性
- 改进输出处理流程
  - 分离命令行输出和文件写入的格式处理
  - 使用`replace`方法动态移除标记
  - 保持原有功能的完整性
  - 优化用户体验，提供更清晰的输出展示

### 更新 6
- 优化了语义分割器功能
  - 更新了`src/utils/semantic_divider.py`的实现
  - 改进了自然段落分割的处理逻辑
  - 增强了语义特征识别能力
  - 优化了段落合并策略
  - 添加了AI辅助的语义关联度分析
  - 实现了动态的段落合并策略调整
  - 更新了相关文档和测试用例

### 更新 7
- 更新了项目文档
  - 更新了`README.md`，添加了新功能说明
  - 更新了`doc_Structure_Description.md`，反映最新的代码结构
  - 添加了语义分割器的详细说明
  - 更新了医学RAG系统的相关文档
  - 保持了所有文档的一致性和完整性


## 2025-4-15
### 更新 1
- 优化了文本差异对比显示功能
  - 更新了`src/utils/text_utils.py`中的颜色方案
  - 设计了8种协调的颜色组合，提升视觉体验：
    - 金黄色：用于突出显示主要差异
    - 天蓝色：标注次要修改
    - 翠绿色：显示添加的内容
    - 淡紫色：标记结构变化
    - 橙色：突出重要修改
    - 青蓝色：标注语言优化
    - 淡黄色：显示格式调整
    - 紫罗兰色：标记其他变化
  - 改进了差异对比的可视化效果
  - 优化了命令行界面的显示效果
  - 提升了文本对比的清晰度和可读性
- 更新了项目文档
  - 更新了`doc_Structure_Description.md`中的模块描述
  - 添加了新的颜色方案说明
  - 更新了行数统计

## 2025-04-16 更新
1. 修复了 R² 框架中的 JSON 解析错误
   - 改进了 `reader.py` 中的 JSON 处理逻辑
   - 添加了更严格的错误处理和验证
   - 优化了数据处理和类型转换

2. 增强了 `ai_review.py` 的错误处理
   - 添加了更详细的错误信息输出
   - 改进了属性访问的安全性
   - 优化了结果处理逻辑